<!DOCTYPE html>
<html lang="ru">

<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
* {
    margin:  0px;
    padding: 0px;
    border:  0px; 
}

html {
    height: 100%;
    font: 14px Verdana, Arial, Helvetica, sans-serif;
}

body {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

div {
    text-align: justify;	
}

p {
    padding: 5px;
}

ul {
    padding-left: 20px;
}

li {
    padding-top: 2px;
    padding-bottom: 2px;
}

a, a:link, a:active, a:visited {
   #color: #0000EE;
   color: #0000DD;
   #color: red;
}

.background-header {
    background: #F7F7FF;
}

.background-menu {
    background: #D0E0FF;
}

.background-menu-line {
    background: #90A0C0;
}

.border-color-menu {
    border-color: #90A0C0;
}

.color-menu-item {
    color: #2020A0;
}

.color-menu-item-selected { 
    color: #E78C43; 
}

.background-menu-selected-top { 
    background: #C8D8E8;
}

.border-color-div-source-code {
    border-color: #909090;
}

.color-source-sql-comment {
    color: #008000;
}

.color-source-sql-string {
    color: #800060;
}

.color-source-sql-keyword {
    color: #000080;
}

.color-source-sql-block-border {
    color: #DD0000;
}

.color-source-shell {
    color: green;
}

.background-source-shell {
    background: black;    
}

.color-source-html-tag {
    color: #0000CD;
}

.color-source-html-tag-attrubites {
    color: #B22222;
}

.color-source-html-tag-value {
    color: #008000;
}

.color-source-html-comment {
    color: #808080;
}

.color-source-js-comment {
    color: #008000;
}

.color-source-js-keyword {
    color: #000080;
}

.color-source-js-string {
    color: #800060;
}

.div-page {
    #border: solid 3px red;
    display: flex;
    flex-wrap: nowrap;
}

.div-header-middle {
    #border: solid 3px green;
    display: flex; 
    align-items: center; 
    justify-content: center;
	text-align: center;
}

.div-header-sidebar {
    #border: solid 3px blue;
    display: flex;    
    justify-content: center; 
    align-items: center;
    width: 100%;
} 

.div-content {
    display: flex;
    flex-wrap: nowrap;
    #justify-content: space-evenly; 
    justify-content: space-between;
}

.div-content-panel-left {
    #border: solid 3px green;
    width:     260px;
    min-width: 260px;
    max-width: 260px;
    float: left;
    text-align: left;
    padding-top: 10px;
    padding-bottom: 15px;
} 

.div-content-body {
    #border: solid 3px blue;
    padding: 10px 30px 10px 10px;
    border-left-style: solid;
    border-left-width: 2px;
}

.menu-border-top {
    border-top-style: solid;
    border-top-width: 2px;
} 

.menu-border-left {
    border-left-style: solid;
    border-left-width: 2px;
}

.menu-border-right {
    border-right-style: solid;
    border-right-width: 2px;
}

.menu-border-bottom {
    border-bottom-style: solid;
    border-bottom-width: 2px;
}

.menu-top-item {
    text-decoration: none;
    font-size: larger;
    white-space: nowrap;
}

.menu-top-item-selected {
    font-size: larger;
    font-weight: bold;
    white-space: nowrap;
}

.menu-panel-left-item {
    padding-left: 15px;
    text-decoration: none; 
    font-size: larger;
}

.menu-panel-left-item-selected {
    padding-left: 25px;
    font-size: larger;
    font-weight: bold;
}

.nav-static-line {
    font-size: larger;
    background: #D0E0FF;
}
    
.nav-static-line > ul {
    list-style: none;
    padding: 0px;
}

.nav-static-line > ul > li {
    #border: 2px solid red;
    padding: 0px;
    float: left;    
    position: relative;
    text-align: center;
    text-decoration: none;
}
   
.nav-static-line .item {
    padding: 7px;      
    display: block;
    text-align: center;
    text-decoration: none;
}

.nav-static-line .item-selected {
    font-weight: bold;
}

.nav-mobile {
    margin: 0 auto;
	float: left;
    background: #D0E0FF;
}
   
.nav-mobile ul {
    list-style: none;
    margin: 0 auto;
    padding: 0;
}

.nav-mobile li li {
	width: 160px;
}
   
.nav-mobile > ul > li {
    float: left;
    position: relative;
    text-align: left;
    text-decoration: none;
}

.nav-mobile-group-root {
    display: none;
    position: absolute;
    top: 100%;
}

.nav-mobile li:hover > .nav-mobile-group-root {
    display: block;
}

.nav-mobile-group-child {
	display: none;
	position: absolute;
	left: 100%;
	top: 0;
}
    
.nav-mobile li li:hover > .nav-mobile-group-child-1 {
	display: block;
}

.nav-mobile li li li:hover > .nav-mobile-group-child-2 {
	display: block;
}

.nav-mobile-item {  
    padding: 6px;    
    display: block;
    text-align: left;
    text-decoration: none;
    color: #2020A0;	
}

.nav-mobile-item:hover {
   background: #2F718E;
}

.ul-articles li {
    padding-top: 17px;
}

.div-video-iframe {
    width: 560px;
    height: 315px;
}

.div-source-code {
    #border: solid 3px red;
    overflow:scroll;
    min-width: 95%;
    max-width: 200px;   
    border-style: solid;
    border-width: 1px; 
    padding: 2px 3px; 
    font-family: monospace;
    text-align: left;
}

.table-source-code {
    border-collapse: collapse;
    overflow:scroll;
    min-width: 95%;
    max-width: 200px;   
    vertical-align: middle;
}

.table-source-code th {
    border-style: solid;
    border-width: 1px; 
    border-collapse: collapse;
    padding: 3px;
    font-family: monospace;
    text-align: center;
}

.table-source-code td {
    border-style: solid;
    border-width: 1px; 
    border-collapse: collapse;
    padding: 3px 5px; 
    font-family: monospace;
    text-align: left;
}

.div-download {
    border-style: solid;
    border-width: 1px;  
    text-align: center;
}

.a-download {
    text-decoration: none;
}

.div-documentation-synopsis {
    #border: solid 3px red;
    margin-left:    30px;
    margin-right:    0px; 
    margin-top:      3px;
    margin-bottom:   0px;
}

.div-documentation-desc {
    #border: solid 3px red;
    margin-left:    30px;
    margin-right:  100px; 
    margin-top:      3px;
    margin-bottom:   0px;
}

@media (max-width: 900px) {

    #header-desktop {
        display: none;
    }

    #menu-top-line-1 {
        display: none;
    }

    .div-content-panel-left {
        display: none;
    } 

    .div-content-body {
        border-left-width: 0px;
        padding: 5px;
    }

    .div-video-iframe {
        width: 370px;
        height: 210px;
    }

}

@media not (max-width: 900px) {

    #header-mobile {
        display: none;
    }

}

.button-top {
  display: none; 
  position: fixed;
  right: 10px;
  bottom: 40px;
  cursor: pointer;
  font-size: 18px;
  padding: 5px 8px;
  border-style: solid; 
  border-width: 2px;
}

.button-top-visible {
  display: block;
} 
</style>


<title>PGVIP | Документация</title>
	
</head>
<body>

<div id="header-desktop" class="div-page background-header menu-border-bottom border-color-menu" style="justify-content: center; padding: 10px;">

  <h1>PGVIP | Документация</h1>

</div>


<div class='div-page' style='flex: 1; clear:both;'>

  <div class='div-content-panel-left'>
    

<ul>
<li><a href="#description">Описание</a></li>
<li><a href="#actions">Действия</a></li>
<li><a href="#command-line">Командная строка</a></li>
</ul>



  </div>

  <div class='div-content-body border-content-body border-color-menu'>
    

<a id="description"></a>
<p><b>Описание</b></p>
<br>

При запуске служба pgvip (модуль <a href="https://github.com/PGSuite/PGVIP/blob/main/pgvip.c" target="_blank">pgvip.c</a>) загружает параметры из конфигурационного файла <a href="https://github.com/PGSuite/PGVIP/blob/main/pgvip.conf" target="_blank">pgvip.conf</a> в глобальные переменные (<a href="https://github.com/PGSuite/PGVIP/blob/main/global.h" target="_blank">global.h</a>,<a href="https://github.com/PGSuite/PGVIP/blob/main/global.c" target="_blank">global.c</a>),
на основе шаблонов с переменными формирует финальные команды операционной системы.
Всем параметрам конфигурационного файла и финальным командам соответствуют одноименные глобальные переменные с префиксом <em>g_</em>.
<br>
Далее запускает нити:
<br>
<table>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">CHECKER_MASTER_DB, CHECKER_STANDBY_DB</td><td style="text-align: center; width: 30px;">-</td><td>проверка состояния баз данных (<a href="https://github.com/PGSuite/PGVIP/blob/main/checker.c" target="_blank">checker.c</a>)</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">CHECKER_MASTER_VIP, CHECKER_STANDBY_VIP</td><td style="text-align: center; width: 30px;">-</td><td>проверка виртуального IP адреса (<a href="https://github.com/PGSuite/PGVIP/blob/main/checker.c" target="_blank">checker.c</a>)</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">ACTION_EXECUTOR</td><td style="text-align: center; width: 30px;">-</td><td>выполнение действий (<a href="https://github.com/PGSuite/PGVIP/blob/main/action.c" target="_blank">action.c</a>)</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">ADMINISTRATION</td><td style="text-align: center; width: 30px;">-</td><td>обработка команд <em>status</em>, <em>stop</em> и <em>show</em> (<a href="https://github.com/PGSuite/PGVIP/blob/main/util/util_admin.c" target="_blank">util_admin.c</a>)</td></tr>
</table>

<br>


Нити проверок с интервалом <em>{time_check_interval}</em> выполняют команды <em>{command_db_state},{command_vip_state}</em> и результат записывают в глобальную переменную <em>g_status</em>.
В журнал собщений выводятся только команды выполненные с ошибкой.
<br>
<br>
Нить действий с интервалом <em>{time_command_ssh_timeout_int+time_check_interval_int+1}</em> последовательно выполняет действия из списка (массив процедур), которые
при успешной проверке условия из переменной <em>g_status</em> выполняют команды ОС (как правило, одну).
Результаты действий не анализируются, они будут получены проверками на всех web-серверах.
<br>
В журнал сообщений выводится:
<br>
<ul style="margin: 0; padding-left: 20px;">
<li>название действия: реальное название процедуры (<em>__func__</em>)</li>
<li>первоначальное состояние: <em>pgvip status</em></li>
<li>выполненное условие: реальный фрагмент кода Си (<em>#define action_condition_text(condition) #condition</em>)</li>
<li>команды операционной системы: текст команды, вывод stdout/stderr, код завершения</li>
</ul>
<br><br>


<a id="actions"></a>
<div class="color-menu-item-selected background-menu" style="width: 100%; font-weight: bold; padding: 3px;">
Действия
</div>

<br>
Таблица действий сгенерирована из модуля action.c<br>
Для получения текста команды по названию переменной в командной строке нужно выполнить<br>
<em>pgvip show config | grep [var]</em>
<br><br>
<table class="table-source-code border-color-menu">
  <tr>
  <th class="background-header">Действие (процедура)</th>  <th class="background-header">Условие (if)</th>  <th class="background-header">Команды (переменные)</th>  </tr>
  <tr>
    <td>action_master_vip_auto_down_execute</td>
    <td>status.master_vip_auto_down==G_VIP_AUTO_DOWN_NOT_EXECUTING</td>
    <td>command_master_vip_auto_down_execute</td>
  </tr>
  <tr>
    <td>action_master_vip_up</td>
    <td>status.standby_db_state!=G_DB_STATE_READ_WRITE &&<br>status.master_db_state==G_DB_STATE_READ_WRITE &&<br>status.master_vip_state==G_VIP_STATE_DOWN &&<br>status.master_vip_auto_down==G_VIP_AUTO_DOWN_EXECUTING</td>
    <td>command_master_vip_up</td>
  </tr>
  <tr>
    <td>action_master_vip_down</td>
    <td>status.master_vip_state==G_VIP_STATE_UP &&<br>(status.master_db_state!=G_DB_STATE_READ_WRITE ||<br>status.standby_db_state==G_DB_STATE_READ_WRITE)</td>
    <td>command_master_vip_down</td>
  </tr>
  <tr>
    <td>action_standby_vip_auto_down_execute</td>
    <td>status.standby_vip_auto_down==G_VIP_AUTO_DOWN_NOT_EXECUTING</td>
    <td>command_standby_vip_auto_down_execute</td>
  </tr>
  <tr>
    <td>action_standby_vip_up</td>
    <td>status.master_vip_state!=G_VIP_STATE_UP &&<br>status.standby_db_state==G_DB_STATE_READ_WRITE &&<br>status.standby_vip_state==G_VIP_STATE_DOWN &&<br>status.standby_vip_auto_down==G_VIP_AUTO_DOWN_EXECUTING</td>
    <td>command_standby_vip_up</td>
  </tr>
  <tr>
    <td>action_standby_vip_down</td>
    <td>status.standby_vip_state==G_VIP_STATE_UP &&<br>status.standby_db_state!=G_DB_STATE_READ_WRITE</td>
    <td>command_standby_vip_down</td>
  </tr>
  <tr>
    <td>action_standby_db_promote</td>
    <td>status.master_db_state!=G_DB_STATE_READ_WRITE &&<br>status.standby_db_state==G_DB_STATE_IN_RECOVERY &&<br>(time_now()-status.value_time)&gt;g_time_standby_promote_delay_int &&<br>status.standby_db_lag&lt;=g_time_standby_allowable_lag_int</td>
    <td>command_master_vip_down<br>command_standby_db_promote<br>command_standby_vip_up</td>
  </tr>
  <tr>
    <td>action_master_db_break</td>
    <td>status.master_db_state==G_DB_STATE_READ_WRITE &&<br>status.standby_db_state==G_DB_STATE_READ_WRITE</td>
    <td>command_master_db_break</td>
  </tr>
</table>

<br><br>


<a id="command-line"></a>
<div class="color-menu-item-selected background-menu" style="width: 100%; font-weight: bold; padding: 3px;">
Командная строка
</div>

<br>

Параметры командной строки (после установки их можно посмотреть запустив <em>pgvip --help</em>)<br>
<div class="div-source-code border-color-div-source-code color-source-shell background-source-shell" style="height: 400px;">
<pre>﻿[root@web-server ~]# pgvip --help
PGVIP is a PostgreSQL master-standby auto failover service via a virtual IP address
version 25.1.1, linux 64 bits

All parameters (IP addresses, OS commands, timings) in the configuration file /etc/pgvip.conf

Usage:
  pgvip {COMMAND}

Commands:
  start        start execution in another process
  execute      execute in current process
  status       show status
  stop         stop execution
  show config  show runtime configuration
  help|man     print this help

Examples:
  pgvip execute
  pgvip status
  pgvip show config
</pre>
</div>
<br>
<br>




  </div>

</div>

</body>
</html>